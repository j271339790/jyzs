<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="initialize.css">
    <style>
        .out {position: relative; margin: 0 auto;}
        .in {float: left;}
        img {
            margin: 10px;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #666;
            box-shadow: 0 0 5px #ff7ba5;
        }
    </style>
</head>
<body>
<div class="out"></div>
<script>
    //在outDiv中根据数据创建inDiv的函数
    function createInDiv_in_OutDiv(){
        for(var i=0; i<dataObj.src.length; i++){
            var div = document.createElement('div');
            div.setAttribute('class','in');
            div.innerHTML = '<img src="img/'+dataObj.src[i]+'" alt="">';
            outDiv.appendChild(div);
        }
    }
    //创建瀑布流函数
    function waterFall() {
        var inDivArr = document.getElementsByClassName("in");
        var num = Math.floor(document.documentElement.clientWidth/inDivArr[0].offsetWidth);
        outDiv.style.width = num*inDivArr[0].offsetWidth+'px'; 
        var heightArr = []; 
        for(var i=0;i<inDivArr.length;i++){ 
            if(i<num){ 
                heightArr.push(inDivArr[i].offsetHeight);
            }else { 
                inDivArr[i].style.position = "absolute";
                var minHeight = Math.min.apply(null,heightArr); 
                var minIndex = heightArr.indexOf(minHeight);
                inDivArr[i].style.top = minHeight+'px'; 
                inDivArr[i].style.left = inDivArr[minIndex].offsetLeft+'px'; 
                heightArr[minIndex] = heightArr[minIndex]+inDivArr[i].offsetHeight;
            }
        }
    }
    //判断是否需要加载新数据的函数
    function ifAppendNewData() {
        var height1 = document.documentElement.scrollTop || document.body.scrollTop;
        var height2 = document.documentElement.clientHeight;
        var inDivArr = document.getElementsByClassName("in");
        var height3 = inDivArr[inDivArr.length - 1].offsetTop;
        if((height1+height2)>height3){
            return true;
        }
    }

    //获取服务器数据并处理
    var dataStr = '{"src":["i1.jpg","i2.jpg","i3.jpg","i4.jpg","i5.jpg","i6.jpg","i7.jpg","i8.jpg","i9.jpg","i10.jpg","i11.jpg","i12.jpg","i13.jpg","i14.jpg","i15.jpg"]}';
    var dataObj = JSON.parse(dataStr);
    
    //创建页面
    var outDiv = document.querySelector('.out');
    //在outDiv中绘制inDiv
    createInDiv_in_OutDiv();
    //页面绘制完毕后，将页面的内容按照瀑布流排列
    window.onload = function () { 
        waterFall();
    };
    
    //页面滚动时检测是否需要添加数据
    window.onscroll = function () {
        if(ifAppendNewData()){
            //如果需要添加新数据，就向outDiv中再添加15个数据
            createInDiv_in_OutDiv();
            //然后把整体重新按照瀑布流的方式重新排列一边
            waterFall();
        }
    };
    //页面大小发生改变的时候，调用瀑布流排列将页面重新排布
    window.onresize = function () {
        waterFall();
    };

</script>
</body>
</html>